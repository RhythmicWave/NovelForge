---
description: NovelForge 工程开发规则（架构优雅性、低耦合、可维护性）
globs:
  - "backend/**/*.py"
  - "frontend/src/renderer/src/**/*.{ts,vue}"
  - "docs/**/*.md"
alwaysApply: true
---

# NovelForge Engineering Rule

## 0) 目标

所有开发行为以“长期可维护”为第一优先级：

1. 低耦合（模块边界清晰）
2. 高内聚（单一职责）
3. 可验证（变更有校验闭环）
4. 可演进（避免一次性写死）

禁止为了“先跑通”引入难以回收的硬编码和隐式行为。

---

## 1) 架构与解耦规则

### 1.1 事件驱动优先

- 跨域联动（例如“保存卡片后触发工作流”）必须优先采用事件发布/订阅。
- 禁止在业务入口里直接串联多个下游模块实现“硬调用链”。

### 1.2 插件化注册优先

- 可扩展能力（初始化器、工作流节点、事件处理器）必须通过装饰器注册。
- 新增能力必须完成“两步”：
  1) 定义并加装饰器
  2) 在对应 `__init__.py` 导入，确保注册生效

### 1.3 配置集中管理

- 所有可变参数必须进入统一配置体系（环境变量 + 配置对象）。
- 禁止在业务代码中硬编码：URL、开关、阈值、模型名、超时、重试次数。

---

## 2) 服务层与接口规则

### 2.1 单一职责

- 一个 service 只负责一个领域。
- 复杂能力拆分为“小服务 + 协调层”，禁止“巨型上帝类服务”。

### 2.2 依赖注入

- 通过参数注入 `Session`、配置、依赖对象。
- 禁止在函数内部偷偷创建全局依赖实例并长期持有。

### 2.3 API 契约唯一来源

- 类型定义以后端 schema 为唯一真相。
- 前端必须使用 OpenAPI 生成类型；禁止手写重复接口类型并长期并存。
- 前端不要重复构建后端模型或接口类型，优先通过 `npm run gen:types` 从后端生成并复用。
- 任何 API 端点必须声明清晰响应模型，确保契约可生成。

---

## 3) 工作流系统规则

### 3.1 代码修改闭环

- 任何工作流代码改动必须走“可验证闭环”：
  1) 生成新代码/补丁
  2) parse
  3) validate
  4) 通过后才应用

- 禁止跳过校验直接落库。

### 3.2 可视化编辑安全性

- 可视化参数修改不得直接拼接字符串写回。
- 必须处理好字面量编码/转义，避免把合法值写成带多余引号的错误代码。
- 任何前端写回都必须经过服务端校验结果确认。

### 3.3 运行能力一致性

- 工作流功能设计必须考虑：
  - 后台运行可见性（全局状态反馈）
  - 节点级进度上报
  - 暂停/恢复
  - 运行记录保留策略（临时 vs 持久化）

- 新功能不得破坏以上能力的一致语义。

---

## 4) Agent 系统规则

### 4.1 共享层与业务层分离

- 通用消息渲染、流式事件、输入框交互必须复用共享层。
- 业务 Agent 只实现自己的工具与策略，不复制一套 UI/协议。

### 4.2 单轨展示，避免双实现

- 同一语义（如消息时间线）禁止维护两套并行显示逻辑。
- 若确需新增模式，必须证明旧模式无法满足需求，并给出迁移计划。

### 4.3 运行期依赖必须明确

- 关键提示词等运行依赖缺失时应明确报错。
- 禁止加入“只在源码目录可用”的隐式兜底读取逻辑。

---

## 5) 前端工程规则

### 5.1 组件规模控制

- 超大组件必须持续拆分（UI、状态、事件处理、数据转换分离）。
- 优先抽离：共享组件、composable、类型定义。

### 5.2 暗黑模式与主题

- 样式必须优先使用主题变量。
- 禁止硬编码浅色文本导致暗黑模式不可读。

### 5.3 状态与事件一致性

- 任何流式交互都必须有明确状态机（idle/running/stopped/error）。
- “发送/中止”必须共用一个动作入口，避免双按钮状态冲突。

---

## 6) 数据与健壮性规则

### 6.1 输入容错与字段兜底

- 事件负载和节点输入必须做必需字段防御性处理。
- 对关键字段允许“多层回退解析”，避免因 `None` 直接中断整条链路。

### 6.2 事务与异常边界

- 失败必须可回滚，不得产生半成功脏状态。
- 对可降级功能（例如非关键联动）可捕获异常，但必须记录结构化日志。

---

## 7) 编码与变更规则

### 7.1 最小变更原则

- 只改与目标相关的文件和逻辑。
- 禁止无关重构、无关命名重写、无关格式化噪音。

### 7.2 编码与文件安全

- 文本文件统一使用 UTF-8。
- 禁止在不确认编码的情况下整文件重写，优先局部补丁。

### 7.3 禁止反模式

禁止以下行为：

- 为“快”而复制粘贴同构逻辑（前后端、模块间）
- 在多个位置维护同一份业务规则
- 用前端临时字符串规则替代后端正式校验
- 把过程性调试开关长期暴露给用户而无产品意义

---

## 8) 验证与交付规则

### 8.1 必做校验

- 后端改动：至少做目标接口/流程级验证。
- 前端改动：至少做关键路径交互验证（加载、提交、错误分支）。
- 工作流相关改动：必须验证 parse/validate/run 的完整链路。

### 8.2 变更说明

- 交付说明必须包含：改动范围、行为变化、已验证内容、已知限制。
- 如果存在暂未解决的边界问题，必须显式标注，不得隐藏。

---

## 9) 决策优先级（冲突时）

当多个方案都能实现功能时，按以下优先级决策：

1. 破坏性最小
2. 复用性最高
3. 校验链最完整
4. 用户体验最一致
5. 实现复杂度适中

若以上无法兼顾，先保证正确性与可维护性，再优化体验。
